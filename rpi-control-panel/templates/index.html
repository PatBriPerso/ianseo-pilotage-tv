<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Contrôle des TV</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Optional: Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* Styles optimisés mobile */
    .tv-card,
    .display-card {
      margin-bottom: 1rem;
    }
    .tv-card .form-control,
    .display-card .form-control {
      font-size: 16px; /* Évite le zoom iOS */
      padding: 0.5rem;
    }
    .tv-card .btn,
    .display-card .btn {
      padding: 0.5rem 1rem;
      min-height: 44px; /* Taille minimum touch target */
    }
    .display-card .btn-group-vertical {
      gap: 0.5rem !important;
    }
    .display-card .card-text {
      cursor: help;
    }
    /* Table responsive custom */
    .table-displays {
      display: block;
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .table-displays td {
      min-width: 120px;
    }
    .table-displays .btn-group-tv {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    .btn-group-tv .btn {
      flex: 1;
      min-width: 80px;
      margin: 2px;
    }
    /* Formulaire d'URL manuelle */
    .manual-url-form {
      flex-direction: column;
      gap: 0.5rem;
    }
    .manual-url-form input {
      max-width: 100% !important;
      font-size: 16px;
    }
    .manual-url-form button {
      width: 100%;
      min-height: 44px;
    }
    /* Espacement adaptatif */
    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      h2 {
        font-size: 1.5rem;
      }
      h3 {
        font-size: 1.25rem;
      }
    }
  </style>
</head>

<body>
  <div class="container my-2 my-md-4">
    <h2 class="text-center mb-4">Interface de contrôle des TV</h2>

    <!-- Bouton Rafraîchir -->
    <div class="text-center mb-3">
      <button type="button" class="btn btn-secondary" onclick="updateTVStatus()">Rafraîchir l'état des TV</button>
    </div>

    <!-- Tableau des TV -->
    <h3>TV (config)</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mb-4">
      {% for tv in tvs %}
      <div class="col">
        <div class="card tv-card h-100 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">{{ tv.name }}</h5>
            <p class="card-text mb-1"><strong>IP :</strong> {{ tv.ip }} - <strong>Port :</strong> {{ tv.port }}</p>

            <form method="POST" action="{{ url_for('send_url', index=loop.index0) }}" class="d-flex mb-2">
              <input type="text" class="form-control me-2 form-control-sm" name="url" value="{{ tv.url }}">
              <button type="submit" class="btn btn-primary btn-sm">Envoyer</button>
            </form>

            <p class="mb-1"><strong>État :</strong>
              <span class="
                {% if 'Erreur' in tv.status %}text-warning fw-bold
                {% elif tv.status == 'en ligne' %}text-success fw-bold
                {% else %}text-danger fw-bold{% endif %} tv-status">{{ tv.status }}</span>
            </p>
            <p class="mb-0"><strong>Dernière URL :</strong> <span class="tv-last-url">{{ tv.last_url }}</span></p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Tableau affichages prédéfinis -->
    <h3>Affichages prédéfinis</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mb-4">
      {% for disp_index in range(displays|length) %}
      <div class="col">
        <div class="card display-card h-100 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">{{ displays[disp_index].name }}</h5>
            <p class="card-text mb-3 text-truncate" title="{{ displays[disp_index].url }}">
              <strong>URL :</strong> {{ displays[disp_index].url }}
            </p>
            
            <div class="d-flex flex-column gap-2">
              <p class="mb-2"><strong>Envoyer à :</strong></p>
              <div class="btn-group-vertical w-100 gap-1">
                {% for tv_index in range(tvs|length) %}
                <form method="POST" action="/send_display/{{ disp_index }}/to/{{ tv_index }}" class="w-100">
                  <button type="submit" class="btn btn-outline-primary w-100">{{ tvs[tv_index]["name"] }}</button>
                </form>
                {% endfor %}
                <form method="POST" action="/send_display/{{ disp_index }}/to_all" class="w-100">
                  <button type="submit" class="btn btn-success w-100 mt-2">Toutes les TV</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Envoyer URL manuelle -->
    <h3>Envoyer une URL manuellement</h3>
    <form method="POST" action="{{ url_for('send_all') }}" class="d-flex manual-url-form mb-4">
      <input type="text" class="form-control" name="url" placeholder="https://...">
      <button type="submit" class="btn btn-warning">Envoyer à toutes les TV</button>
    </form>

    <p class="text-center text-muted small">Mot de passe RPi utilisé : <strong>{{ password }}</strong></p>
  </div>
  <script>
    function updateTVStatus() {
      fetch("/tv_status")
        .then(response => response.json())
        .then(data => {
          data.forEach((tv, index) => {
            // Mettre à jour la colonne "État"
            const statusCell = document.querySelectorAll(".tv-card")[index].querySelector(".tv-status");
            statusCell.textContent = tv.status;
            statusCell.className = "tv-status"; // réinitialiser

            if (tv.status.includes("Erreur")) {
              statusCell.classList.add("text-warning", "fw-bold");
            } else if (tv.status === "en ligne") {
              statusCell.classList.add("text-success", "fw-bold");
            } else {
              statusCell.classList.add("text-danger", "fw-bold");
            }

            // Mettre à jour la dernière URL
            const lastUrlCell = document.querySelectorAll(".tv-card")[index].querySelector(".tv-last-url");
            lastUrlCell.textContent = tv.last_url;
          });
        })
        .catch(err => console.error("Erreur récupération statut TV:", err));
    }

    // Rafraîchir toutes les 120 secondes
    setInterval(updateTVStatus, 120 * 1000);

    // Optionnel : rafraîchir immédiatement au chargement
    updateTVStatus();
  </script>
</body>

</html>