<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Contrôle des TV</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Optional: Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* Styles optimisés mobile */
    .tv-card,
    .display-card {
      margin-bottom: 1rem;
    }
    .tv-card .form-control,
    .display-card .form-control {
      font-size: 16px; /* Évite le zoom iOS */
      padding: 0.5rem;
    }
    .tv-card .btn,
    .display-card .btn {
      padding: 0.5rem 1rem;
      min-height: 44px; /* Taille minimum touch target */
    }
    .display-card .btn-group-vertical {
      gap: 0.5rem !important;
    }
    .display-card .card-text {
      cursor: help;
    }
    /* Table responsive custom */
    .table-displays {
      display: block;
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .table-displays td {
      min-width: 120px;
    }
    .table-displays .btn-group-tv {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    .btn-group-tv .btn {
      flex: 1;
      min-width: 80px;
      margin: 2px;
    }
    /* Formulaire d'URL manuelle */
    .manual-url-form {
      flex-direction: column;
      gap: 0.5rem;
    }
    .manual-url-form input {
      max-width: 100% !important;
      font-size: 16px;
    }
    .manual-url-form button {
      width: 100%;
      min-height: 44px;
    }
    /* Espacement adaptatif */
    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      h2 {
        font-size: 1.5rem;
      }
      h3 {
        font-size: 1.25rem;
      }
    }
  </style>
</head>

<body>
  <div class="container my-2 my-md-4">
    <h2 class="text-center mb-4">Interface de contrôle des TV</h2>

    <!-- Bouton Rafraîchir -->
    <div class="text-center mb-3">
      <button type="button" class="btn btn-secondary" onclick="updateTVStatus()">Rafraîchir l'état des TV</button>
    </div>

    <!-- Tableau des TV -->
    <h3>TV</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mb-4">
      {% for tv in tvs %}
      <div class="col">
        <div class="card tv-card h-100 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">{{ tv.name }}</h5>
            <p class="card-text mb-2"><strong>IP :</strong> {{ tv.ip }} - <strong>Port :</strong> {{ tv.port }}</p>
            
            <p class="mb-2"><strong>État :</strong>
              <span class="
                {% if 'Erreur' in tv.status %}text-warning fw-bold
                {% elif tv.status == 'en ligne' %}text-success fw-bold
                {% else %}text-danger fw-bold{% endif %} tv-status" 
                {% if 'Erreur' in tv.status %}title="{{ tv.status }}"{% endif %}>
                {% if 'Erreur' in tv.status %}erreur{% else %}{{ tv.status }}{% endif %}
              </span>
            </p>
            <p class="mb-0 text-truncate">
              <strong>Dernière URL :</strong> 
              <span class="tv-last-url" title="{{ tv.last_url }}">
              {% set display_name = namespace(found=false) %}
              {% for display in displays %}
                {% if display.url == tv.last_url %}
                  {% set display_name.found = true %}
                  <span class="badge bg-primary">{{ display.name }}</span>
                {% endif %}
              {% endfor %}
              {% if not display_name.found %}
                {{ tv.last_url }}
              {% endif %}
              </span>
            </p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Tableau affichages prédéfinis -->
    <h3>Affichages prédéfinis</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mb-4">
      {% for disp_index in range(displays|length) %}
      <div class="col">
        <div class="card display-card h-100 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">{{ displays[disp_index].name }}</h5>
            <p class="card-text mb-3 text-truncate" title="{{ displays[disp_index].url }}">
              <strong>URL :</strong> {{ displays[disp_index].url }}
            </p>
            
            <div class="d-flex flex-column gap-2">
              <p class="mb-2"><strong>Envoyer à :</strong></p>
              <div class="btn-group-vertical w-100 gap-1">
                {% for tv_index in range(tvs|length) %}
                <form method="POST" action="/send_display/{{ disp_index }}/to/{{ tv_index }}" class="w-100">
                  <button type="submit" class="btn btn-outline-primary w-100">{{ tvs[tv_index]["name"] }}</button>
                </form>
                {% endfor %}
                <form method="POST" action="/send_display/{{ disp_index }}/to_all" class="w-100">
                  <button type="submit" class="btn btn-success w-100 mt-2">Toutes les TV</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Envoyer URL manuelle -->
    <h3>Envoyer une URL manuellement</h3>
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <input type="text" class="form-control" id="manualUrl" placeholder="https://..." 
                   oninput="updateManualUrlForms(this.value)">
          </div>
          <div class="col-12">
            <div class="d-flex flex-column gap-2">
              <p class="mb-2"><strong>Envoyer à :</strong></p>
              <div class="btn-group-vertical w-100 gap-1">
                {% for tv in tvs %}
                <form method="POST" action="{{ url_for('send_url', index=loop.index0) }}" class="w-100">
                  <input type="hidden" name="url" class="manual-url-input">
                  <button type="submit" class="btn btn-outline-primary w-100">{{ tv.name }}</button>
                </form>
                {% endfor %}
                <form method="POST" action="{{ url_for('send_all') }}" class="w-100">
                  <input type="hidden" name="url" class="manual-url-input">
                  <button type="submit" class="btn btn-warning w-100 mt-2">Toutes les TV</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <p class="text-center text-muted small mt-3">Mot de passe RPi utilisé : <strong>{{ password }}</strong></p>

    <script>
      function updateManualUrlForms(url) {
        document.querySelectorAll('.manual-url-input').forEach(input => {
          input.value = url;
        });
      }
    </script>
  </div>
  <script>
    // Liste des affichages prédéfinis (à initialiser au chargement)
    const predefinedDisplays = [
      {% for display in displays %}
      { name: "{{ display.name }}", url: "{{ display.url }}" }{{ "," if not loop.last }}
      {% endfor %}
    ];

    function updateTVStatus() {
      fetch("/tv_status")
        .then(response => response.json())
        .then(data => {
          data.forEach((tv, index) => {
            // Mettre à jour la colonne "État"
            const statusCell = document.querySelectorAll(".tv-card")[index].querySelector(".tv-status");
            statusCell.textContent = tv.status;
            statusCell.className = "tv-status"; // réinitialiser

            if (tv.status.includes("Erreur")) {
              statusCell.classList.add("text-warning", "fw-bold");
              statusCell.setAttribute("title", tv.status);
              statusCell.textContent = "erreur";
            } else if (tv.status === "en ligne") {
              statusCell.classList.add("text-success", "fw-bold");
            } else {
              statusCell.classList.add("text-danger", "fw-bold");
            }

            // Mettre à jour la dernière URL
            const lastUrlCell = document.querySelectorAll(".tv-card")[index].querySelector(".tv-last-url");
            lastUrlCell.setAttribute("title", tv.last_url);
            
            // Vérifier si l'URL correspond à un affichage prédéfini
            const matchingDisplay = predefinedDisplays.find(display => display.url === tv.last_url);
            if (matchingDisplay) {
              lastUrlCell.innerHTML = `<span class="badge bg-primary">${matchingDisplay.name}</span>`;
            } else {
              lastUrlCell.textContent = tv.last_url;
            }
          });
        })
        .catch(err => console.error("Erreur récupération statut TV:", err));
    }

    // Rafraîchir toutes les 120 secondes
    setInterval(updateTVStatus, 120 * 1000);

    // Optionnel : rafraîchir immédiatement au chargement
    updateTVStatus();
  </script>
</body>

</html>